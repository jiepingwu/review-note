### MySQL为什么有时候会"抖"一下

有没有遇到过，正常执行一条SQL语句的时候很快，但有的时候不知道怎么回事，就变得特别慢，而且问题很难复现，不仅随机，而且持续时间很短。

看上去，就像是数据库"抖"了一下。这是什么原因呢？



#### SQL语句为什么变"慢"了

先说结论：可能是因为正在 **刷脏页**。



#### 刷脏页是什么？

我们知道，在更新的时候，不会将更新数据直接写入磁盘中，而是追加写记录在redo log中，并且修改内存中数据页。

而脏页，就是 内存中数据 和 磁盘中数据 不一致的数据页。

刷脏页就是将这两者同步，使用redo log日志将更新批量写入磁盘中。

**所以，MySQL有时候突然执行的比较慢，可能就是正在 刷盘，正常执行的快就是只写入了redo log和刷新内存。**



#### 什么时候刷盘？

1.redo log是一个环形结构，当redo log写不下的时候，就需要清除一下之前的redo log记录，将这些log记录刷盘，更新磁盘对应数据页上的数据。redo log 维护两个指针，write position负责写入，check point检查是否还有剩余空间，redo log满了之后 check point前移，刷盘对应记录的磁盘数据页。

2.当系统内存不足时，需要淘汰一些数据页，为了避免下次读取磁盘数据页时 要进行redo log应用，也会进行刷盘。

​		如果内存不足时淘汰数据页也会刷盘写盘，那么数据页只有两种情况：1. 内存中存在，那么内存中数据就是正确的。2. 如果内存中不存在，那么 磁盘中的数据就是正确的。

3.MySQL空闲的时候，进行刷盘。

4.MySQL退出的时候，进行刷盘，保证下次启动时，磁盘中数据就是正确的数据，而不需要进行应用redo log更新，也是提高了MySQL的启动速度。



#### 四种情况下的刷盘性能上有什么不同？

对于3和4，也就是空闲的时候和退出的时候进行的刷盘，性能上不怎么需要关注。

对于1（redo log写满进行的刷盘）：这种情况innodb是尽量避免的，因为这会阻塞所有的更新操作。

对于2（内存不足，进行的刷盘）：这种情况是比较普遍的。

​	**innodb使用缓存池 buffer pool来管理内存，缓冲池中的内存页有3种情况：1 没有使用的空白页。2 干净页，也就是说对应的数据页已经刷入磁盘。3 脏页，对应的数据页没有刷入磁盘。**

当需要读入的数据页没有在内存中的时候，就会在缓冲池中申请一个数据页，如果缓冲池用完，**只能清除最久不使用的内存页，然后复用。**这个时候，如果清除的是干净页，就不需要刷盘，直接复用；而如果是脏页，就要将对应的数据页进行刷盘。

**所以，redo log写满 和 内存不足，需要淘汰大量脏页 会影响性能。**

redo log**写满导致所有的更新操作阻塞于刷盘**，等刷盘完成后才能更新继续记录入redo log。

内存不足时大量的淘汰脏页，会导致大量的刷盘，所有如果一个查询需要占用大量的内存的话，可能由于内存不足进行大量的刷盘，导致响应时间变得很慢。

所以，**innodb有控制脏页比例的机制**，来避免上面的两种情况。



#### InnoDB 刷脏页的控制策略

innodb刷脏页的速度可以通过 *innodb_io_capacity* 参数来设置，这个参数告诉innodb 服务器的io性能。控制刷盘速度。

有可能innodb_io_capacity设置的太小，比如说SSD磁盘但是innodb_io_capacity设置为300，于是innodb刷盘速度非常慢，导致大量的脏页积累，而大量脏页会导致redo log非常容易写满，并且内存中也可能存在大量脏页，像上面说的，影响查询和插入的性能。

了解一下：innodb刷盘速度通过 脏页比例 和 redo log写速度 来计算得到。



我们知道了，内存中存在大量脏页、redo log很容易写满 可能导致 查询或者更新的性能。所以我们要尽量避免控制脏页比例，防止存在大量脏页。

