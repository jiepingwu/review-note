### MySQL 是怎么保证高可用性的？

除了上一篇中说的 主备一致，也就是 使用 bin log 保证 主库和备库 的最终一致性。

但是，MySQL 要提供高可用能力，只有 最终一致性 是不够的。

或者我们考虑这个问题，最终一致性保证了后，还可能发生什么问题？

这个问题就是 ：**主备延迟**

主备延迟，我们主要考虑的是 同步延迟，即 备库使用 bin log 进行同步时的延迟。

同步过程主要关键时间点如下：

1. 主库A执行完成一个事务，写入 bin log，记为 T1
2. 传递bin log 给备库B，备库B接收完这个bin log 的时刻，记为 T2
3. 备库B 执行完成这个事务，记为 T3

所谓 主备延迟，就是同一个 事务，在备库执行完成的时间和主库执行完成的时间之间的时间差，即 T3 - T1

show slave status 结果中显示 seconds_behind_master 会计算这个插值。

**主备延迟最直接的表现就是：备库消费中转日志(relay log)的速度，比主库生产bin log 的速度要慢。**



**主备延迟的来源**

1. **备库机器性能比主库机器差**

2. **备库压力大**

    使用上，一般主库提供写能力，而备库提供读能力，或者一些后台需要的分析语句，不能影响正常业务，只能在备库上跑。

    由于主库直接影响业务，大家使用起来比较克制，但是对于备库的压力控制则忽视了，导致在 备库上消耗了 大量的 CPU资源，影响了同步速度，导致主备延迟。

    **解决方案：**

    1. 一主多备，分担读的压力
    2. 通过 bin log 输出到外部系统，比如 Hadoop 这类系统，让外部系统提供统计类的查询能力

3. **大事务**

    由于bin log 是在主库执行完事务时才会被写入，然后传给 备库，所以，如果 主库上的语句执行10min，那么这个事务就可能导致从库延迟10min。

    一个有关的建议就是：**不要一次性地使用delete 删除太多地数据**，这就是一个大事务场景。

    另一个典型的大事务场景：**大表DDL**，文章13中提到过，大表DDL 需要扫描原数据和构建临时文件，也很消耗IO资源。
    
4. **并行复制**



**解决方案**

​	如何解决 主备延迟的问题？

​	由于 主备延迟 ，所以在 主备切换 的时候，就相应的有不同的策略。

**可靠性优先**

![img](https://static001.geekbang.org/resource/image/54/4a/54f4c7c31e6f0f807c2ab77f78c8844a.png)

​	简单来说，就是 切换主备时，必须保证 主备数据一致，即不存在 主备延迟 后 才能切换。

​	具体过程：

 	1. 等待 备库B 上的 SBM(seconds_behind_master，即 同步延迟时间) 到达一个 较小的数。(因为太大了会导致同步时间过长，即备库 B 消耗 relay log 时间过长。)
 	2. 将 主库A 和 备库B 都设为 read only 状态，即这个时刻处于不可用状态。(原因在于要保证 relay log 完全被 备库B 消耗完成，就不要继续产生新的 bin log)
 	3. 当 备库 B 的 SBM = 0 后，意味着 同步延迟为0，relay log完全同步，两个库数据一致，将 备库B 设为 read only = false。
 	4. 切换 Client 请求到 备库B，即将备库B作为主库。

上面的过程中，比较耗时的是第3步，即等待 备库SBM=0，等待所有的relay log执行完成，两库数据一致。这也就是为什么我们需要等待 SBM 降低到一定小的数时才能进行 主备切换，因为如果很大的SBM，会导致3过程太长，A、B库同时处于 read only 状态时间过长，长期不可用。 

**可用性优先**

​		从上面的过程，我们可用发现，如果我们要 可用性优先，即我们不需要等待 SBM=0，也就说我们不需要等待 两个库 数据一致，直接切换。

​		但是，由于可用性优先，就会带来数据不一致的结果。具体来说：

**当 binlog_format = mixed ，bin log 为 Mixed 模式保存时**：可能会导致 bin log 的延迟执行，即在当前执行语句的后面执行，但是应该在其前面就执行了。

![img](https://static001.geekbang.org/resource/image/37/3a/3786bd6ad37faa34aca25bf1a1d8af3a.png)

**而当 binlog_format=row时**：因为row 格式，bin log 会记录所有新插入的行的字段值，即会定位到行，最后只会有一行不一致。并且两边的主备同步的应用线程会报错 duplicate key error 键重复 而停止。

![image-20210610145416046](..\references-figures\image-20210610145416046.png)

